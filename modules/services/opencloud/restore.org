#+TITLE: Restoring OpenCloud Data from Restic Backup (No /tmp, ZFS Staging Dataset)
#+AUTHOR: Masood Ahmed
#+OPTIONS: toc:nil num:nil

This document restores OpenCloud from Restic backups that were staged under:

- =/mnt/nightly_backup/opencloud-etc=
- =/mnt/nightly_backup/opencloud-idm=
- =/mnt/nightly_backup/opencloud-storage-metadata=
- =/mnt/nightly_backup/opencloud-storage-ocm=
- =/mnt/nightly_backup/opencloud-storage-users=

Because Restic restores files to the same paths captured in the snapshot, it
cannot directly restore these into =/var/lib/opencloud/...= in one step.

Instead, we restore into a *ZFS staging dataset* (not =/tmp=), then copy into
place.

* Backup Information

- Service: =OpenCloud=
- Storage backend: Local filesystem (POSIX, decomposedfs)
- Live base path: =/var/lib/opencloud=

Stop command:

#+begin_src bash
sudo systemctl stop podman-compose-opencloud-root.target
#+end_src

Start command:

#+begin_src bash
sudo systemctl start podman-compose-opencloud-root.target
#+end_src

* Verify Available Snapshots

#+begin_src bash
sudo restic-backup snapshots
#+end_src

Pick a snapshot ID or use =latest=.

* Create a ZFS Staging Dataset (Avoid /tmp)

We create a staging dataset that will temporarily hold the restored
=/mnt/nightly_backup/...= tree. This keeps the extra restore space off of =/tmp=.

Choose a mountpoint, for example:

- =/mnt/restore-staging=

#+begin_src bash
# Create a staging dataset (adjust pool/dataset name as desired)
sudo zfs create -o mountpoint=/mnt/restore-staging dpool/tank/restore-staging

# Confirm it is mounted
mount | grep restore-staging || true
df -h /mnt/restore-staging
#+end_src

* Stop OpenCloud

#+begin_src bash
sudo systemctl stop podman-compose-opencloud-root.target
#+end_src

(Optional) Confirm containers stopped:

#+begin_src bash
sudo podman ps | grep opencloud || echo "OpenCloud stopped"
#+end_src

* (Recommended) Take Pre-Restore ZFS Snapshots (Rollback)

These snapshots allow quick rollback if something goes wrong during restore.

#+begin_src bash
sudo zfs snapshot -r dpool/tank/services/opencloud-etc@pre-restore
sudo zfs snapshot -r dpool/tank/services/opencloud-idm@pre-restore
sudo zfs snapshot -r dpool/tank/services/opencloud-storage-meta@pre-restore
sudo zfs snapshot -r dpool/tank/services/opencloud-storage-ocm@pre-restore
sudo zfs snapshot -r dpool/tank/services/opencloud-storage-user@pre-restore
#+end_src

* Clear Existing Live Data

#+begin_src bash
sudo find /var/lib/opencloud/etc -mindepth 1 -delete
sudo find /var/lib/opencloud/idm -mindepth 1 -delete
sudo find /var/lib/opencloud/nats -mindepth 1 -delete
sudo find /var/lib/opencloud/search -mindepth 1 -delete
sudo find /var/lib/opencloud/storage/metadata -mindepth 1 -delete
sudo find /var/lib/opencloud/storage/ocm -mindepth 1 -delete
sudo find /var/lib/opencloud/storage/users -mindepth 1 -delete
#+end_src

* Restore Snapshot into ZFS Staging Dataset

This restores the staged backup tree into =/mnt/restore-staging=, producing:

=/mnt/restore-staging/mnt/nightly_backup/opencloud-etc=, etc.

#+begin_src bash
SNAPSHOT=latest

sudo restic-backup restore "${SNAPSHOT}" \
  --include /mnt/nightly_backup/opencloud-etc \
  --include /mnt/nightly_backup/opencloud-idm \
  --include /mnt/nightly_backup/opencloud-storage-metadata \
  --include /mnt/nightly_backup/opencloud-storage-ocm \
  --include /mnt/nightly_backup/opencloud-storage-users \
  --target /mnt/restore-staging
#+end_src

Expected layout:

#+begin_example
/mnt/restore-staging/mnt/nightly_backup/opencloud-etc
/mnt/restore-staging/mnt/nightly_backup/opencloud-idm
/mnt/restore-staging/mnt/nightly_backup/opencloud-storage-metadata
/mnt/restore-staging/mnt/nightly_backup/opencloud-storage-ocm
/mnt/restore-staging/mnt/nightly_backup/opencloud-storage-users
#+end_example

* Copy Restored Data into Live OpenCloud Paths

We now copy from the staging dataset into =/var/lib/opencloud=.

IMPORTANT:
- OpenCloud decomposedfs requires extended attributes (xattrs).
- Always use =rsync -aAX= to preserve xattrs and ACLs.

#+begin_src bash
sudo rsync -aAX --delete \
  --chown=opencloud:opencloud \
  /mnt/restore-staging/mnt/nightly_backup/opencloud-etc/ \
  /var/lib/opencloud/etc/

sudo rsync -aAX --delete \
  --chown=opencloud:opencloud \
  /mnt/restore-staging/mnt/nightly_backup/opencloud-idm/ \
  /var/lib/opencloud/idm/

sudo rsync -aAX --delete \
  --chown=opencloud:opencloud \
  /mnt/restore-staging/mnt/nightly_backup/opencloud-storage-metadata/ \
  /var/lib/opencloud/storage/metadata/

sudo rsync -aAX --delete \
  --chown=opencloud:opencloud \
  /mnt/restore-staging/mnt/nightly_backup/opencloud-storage-ocm/ \
  /var/lib/opencloud/storage/ocm/

sudo rsync -aAX --delete \
  --chown=opencloud:opencloud \
  /mnt/restore-staging/mnt/nightly_backup/opencloud-storage-users/ \
  /var/lib/opencloud/storage/users/
#+end_src

* Start OpenCloud

#+begin_src bash
sudo systemctl start podman-compose-opencloud-root.target
#+end_src

(Optional) Confirm containers are running:

#+begin_src bash
sudo podman ps | grep opencloud
#+end_src

* Reindex Search (Recommended After Restore)

After restoring OpenCloud storage, rebuild the search index to ensure all
spaces and files are searchable.

Run the reindex command inside the main OpenCloud container:

#+begin_src bash
sudo podman exec -it opencloud-opencloud \
  opencloud search index --all-spaces
#+end_src

You can monitor progress via logs:

#+begin_src bash
sudo podman logs -f opencloud-opencloud
#+end_src

* Cleanup (Remove Staging Dataset and Pre-Restore Snapshots)

Once satisfied, clean up temporary restore resources.

**1. Destroy the staging dataset:**

#+begin_src bash
sudo zfs destroy -r dpool/tank/restore-staging
#+end_src

**2. Remove the pre-restore rollback snapshots:**

These snapshots were only needed as a safety net during restore. Once the
system is healthy, remove them:

#+begin_src bash
sudo zfs destroy -r dpool/tank/services/opencloud-etc@pre-restore
sudo zfs destroy -r dpool/tank/services/opencloud-idm@pre-restore
sudo zfs destroy -r dpool/tank/services/opencloud-storage-meta@pre-restore
sudo zfs destroy -r dpool/tank/services/opencloud-storage-ocm@pre-restore
sudo zfs destroy -r dpool/tank/services/opencloud-storage-user@pre-restore
#+end_src

(Optional) Verify snapshots are gone:

#+begin_src bash
zfs list -t snapshot | grep pre-restore || echo "Pre-restore snapshots removed"
#+end_src

* Notes & Best Practices

- With your current snapshot layout (=/mnt/nightly_backup/...=), a true one-step restore
  directly into =/var/lib/opencloud= is not possible with Restic alone.
- The above approach avoids =/tmp= completely by using ZFS for staging.
- Always preserve xattrs when copying decomposedfs datasets:
  - Use =rsync -aAX= (not just =-a=)
