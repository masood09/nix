#+TITLE: Restoring Headscale from Restic Backup
#+AUTHOR: Masood Ahmed
#+OPTIONS: toc:nil num:nil

This document describes a *safe, repeatable process* for restoring the
Headscale data directory from a Restic S3 backup staged via
=/mnt/nightly_backup=.

The procedure:
- Restores the latest snapshot
- Stops the service before modifying data
- Replaces the data directory atomically
- Ensures correct ownership
- Cleans up temporary restore artifacts

* Prerequisites

- Restic repository configured (=restic-backup=)
- Sufficient disk space in =/tmp=
- =headscale= system user and group exist
- Service managed via systemd

* 1. Verify Available Snapshots

Confirm the snapshot you intend to restore:

#+begin_src bash
sudo restic-backup snapshots
#+end_src

* 2. Restore the Latest Snapshot to a Temporary Location

Restore only the Headscale dataset into =/tmp=:

#+begin_src bash
sudo restic-backup restore latest \
  --include /mnt/nightly_backup/headscale \
  --target /tmp
#+end_src

This will create the following directory structure:

#+begin_example
/tmp/mnt/nightly_backup/headscale/
#+end_example

* 3. Stop the Headscale Service

Ensure the service is fully stopped before modifying its data directory:

#+begin_src bash
sudo systemctl stop headscale.service
#+end_src

* 4. Clear the Existing Data Directory

Remove all existing contents while preserving the directory itself:

#+begin_src bash
sudo find /var/lib/headscale -mindepth 1 -delete
#+end_src

This approach is:
- Shell-agnostic (bash/zsh)
- Safe even if the directory is already empty

* 5. Promote Restored Data into Place

Copy the restored contents into the live data directory:

#+begin_src bash
sudo rsync -a --delete \
  /tmp/mnt/nightly_backup/headscale/ \
  /var/lib/headscale/
#+end_src

Fix ownership so the service can read and write all files:

#+begin_src bash
sudo chown -R headscale:headscale /var/lib/headscale
#+end_src

* 6. Start the Headscale Service

Bring the service back online:

#+begin_src bash
sudo systemctl start headscale.service
#+end_src

Verify service status:

#+begin_src bash
sudo systemctl status headscale.service
#+end_src

* 7. Clean Up Temporary Restore Files

Remove the temporary restore directory:

#+begin_src bash
sudo rm -rf /tmp/mnt/nightly_backup/headscale
#+end_src

* Notes & Best Practices

- Always stop the service before restoring data to avoid corruption.
- =rsync --delete= ensures the restored state exactly matches the backup.
- Consider taking a *ZFS snapshot* of =/var/lib/headscale= before restoring
  for quick rollback.
