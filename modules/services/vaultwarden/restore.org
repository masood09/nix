#+TITLE: Restoring Vaulwarden Database and Data from Restic Backup
#+AUTHOR: Masood Ahmed
#+OPTIONS: toc:nil num:nil

This document describes a *safe, repeatable procedure* for restoring the
Vaultwarden PostgreSQL database and data files from Restic backups staged
via =/mnt/nightly_backup=.

The workflow:
- Verifies available backups
- Restores database dump and media to a temporary location
- Stops all Authentik services
- Drops and restores the PostgreSQL database
- Fixes ownership of database objects
- Restores data files with correct permissions
- Restarts services cleanly

* Backup Information

- Database: =vaultwarden=
- Database owner: =vaultwarden=
- Database engine: PostgreSQL
- Data path: =/var/lib/vaultwarden=

* Verify Available Snapshots

Confirm the snapshot you intend to restore:

#+begin_src bash
sudo restic-backup snapshots
#+end_src

* Restore the Latest Snapshot to a Temporary Location

Restore the PostgreSQL backup and Vaultwarden data into =/tmp=:

#+begin_src bash
sudo restic-backup restore latest \
  --include /mnt/nightly_backup/postgresql-backup/vaultwarden.sql.gz \
  --target /tmp

sudo restic-backup restore latest \
  --include /mnt/nightly_backup/vaultwarden \
  --target /tmp
#+end_src

This will create the following directory structure:

#+begin_example
/tmp/mnt/nightly_backup/postgresql-backup/vaultwarden.sql.gz
/tmp/mnt/nightly_backup/vaultwarden
#+end_example

* Stop Vaultwarden Service

Stop all Vaultwarden service before restoring the database:

#+begin_src bash
sudo systemctl stop vaultwarden.service
#+end_src

* Drop the Existing Database

Remove the existing database before restoring from backup:

#+begin_src bash
sudo -u postgres psql -d postgres -c "DROP DATABASE vaultwarden;"
sudo systemctl restart postgresql
#+end_src

* Restore the Database

Restore the database from the compressed SQL backup:

#+begin_src bash
sudo cp /tmp/mnt/nightly_backup/postgresql-backup/vaultwarden.sql.gz /tmp/vaultwarden.sql.gz
sudo chmod 644 /tmp/vaultwarden.sql.gz

sudo -u vaultwarden bash -lc \
  'gunzip -c /tmp/vaultwarden.sql.gz | psql -v ON_ERROR_STOP=1 -d vaultwarden'
#+end_src

* Clear the Existing Data Directory

Remove all existing contents while preserving the directory itself:

#+begin_src bash
sudo find /var/lib/vaultwarden -mindepth 1 -delete
#+end_src

This approach is:
- Shell-agnostic (bash/zsh)
- Safe even if the directory is already empty

* Restore Data Files

Copy the restored data into the live directory:

#+begin_src bash
sudo rsync -a --delete \
  /tmp/mnt/nightly_backup/vaultwarden \
  /var/lib/vaultwarden
#+end_src

Fix ownership so the service can read and write all files:

#+begin_src bash
sudo chown -R vaultwarden:vaultwarden /var/lib/vaultwarden
#+end_src

* Start Vaultwarden Service

Restart the Vaultwarden service:

#+begin_src bash
sudo systemctl start vaultwarden.service
#+end_src

* Notes & Best Practices

- Always stop all Vaultwarden service before restoring the database.
- Use =ON_ERROR_STOP= to ensure restore failures abort immediately.
- Consider taking a *ZFS snapshot* of the PostgreSQL data directory and
  Vaultwarden data directory before restoring for quick rollback.
