#+TITLE: Restoring MailArchiver Data from Restic Backup (ZFS Staging Dataset)
#+AUTHOR: Masood Ahmed
#+OPTIONS: toc:nil num:nil

This document restores MailArchiver from Restic backups staged under:

- =/mnt/nightly_backup/mailarchiver=
- PostgreSQL database =mailarchiver=

MailArchiver stores critical state in three places:

1. DataProtection keys → =/var/lib/mailarchiver=
2. PostgreSQL database → =mailarchiver=

Because Restic restores files to the same absolute paths captured in the snapshot,
we restore into a *ZFS staging dataset* first, then copy into place.

* Backup Information

- Service: =MailArchiver=
- Live data paths:

| Component           | Path                                |
|---------------------+-------------------------------------|
| DataProtection keys | =/var/lib/mailarchiver=                           |
| PostgreSQL database | =mailarchiver=                        |

Stop command:

#+begin_src bash
sudo systemctl stop mailarchiver.service
#+end_src

Start command:

#+begin_src bash
sudo systemctl start mailarchiver.service
#+end_src


* Verify Available Restic Snapshots

#+begin_src bash
sudo restic-backup snapshots
#+end_src

Choose snapshot ID or use:

#+begin_src bash
SNAPSHOT=latest
#+end_src


* Create ZFS Staging Dataset

This dataset temporarily holds restored files.

#+begin_src bash
sudo zfs create -o mountpoint=/mnt/restore-staging dpool/tank/restore-staging

mount | grep restore-staging || true
df -h /mnt/restore-staging
#+end_src

Expected mountpoint:

=/mnt/restore-staging=


* Stop MailArchiver

#+begin_src bash
sudo systemctl stop mailarchiver.service
#+end_src


* Take Pre-Restore ZFS Snapshots (Rollback Safety)

#+begin_src bash
sudo zfs snapshot -r fpool/fast/services/mailarchiver@pre-restore
#+end_src

PostgreSQL snapshot (optional but recommended):

#+begin_src bash
sudo zfs snapshot -r dpool/tank/services/postgresql@pre-restore
#+end_src


* Clear Existing Live Data

WARNING: This deletes existing data.

#+begin_src bash
sudo find /var/lib/mailarchiver -mindepth 1 -delete
#+end_src


* Restore Files into ZFS Staging Dataset

#+begin_src bash
SNAPSHOT=latest

sudo restic-backup restore "${SNAPSHOT}" \
  --include /mnt/nightly_backup/mailarchiver \
  --include /mnt/nightly_backup/postgresql-backup/mailarchiver.sql.gz \
  --target /mnt/restore-staging
#+end_src

Expected layout:

#+begin_example
/mnt/restore-staging/mnt/nightly_backup/mailarchiver
#+end_example


* Copy Restored Files into Live Paths

Use =rsync -aAX= to preserve:

- ownership
- permissions
- ACLs
- extended attributes

** Restore MailArchiver keys

#+begin_src bash
sudo rsync -aAX --delete \
  /mnt/restore-staging/mnt/nightly_backup/mailarchiver/ \
  /var/lib/mailarchiver/
#+end_src


* Restore PostgreSQL Database

MailArchiver requires restoring the PostgreSQL database dump from Restic.
This must be done while MailArchiver service is stopped.

** Drop and Recreate Database (Owned by mailarchiver)

Drop the existing database (if it exists), then recreate it with the correct owner:

#+begin_src bash
# Drop existing DB (ignore error if it doesn't exist)
sudo -u postgres psql -d postgres -c "DROP DATABASE IF EXISTS mailarchiver;"

# Recreate DB with correct owner
sudo -u postgres psql -d postgres -c "CREATE DATABASE mailarchiver OWNER mailarchiver;"
#+end_src


** Restore Database from Backup

Copy backup to a temporary location and set safe permissions:

#+begin_src bash
sudo cp \
  /mnt/restore-staging/mnt/nightly_backup/postgresql-backup/mailarchiver.sql.gz \
  /tmp/mailarchiver.sql.gz

sudo chmod 644 /tmp/mailarchiver.sql.gz
#+end_src


Import into =mailarchiver= as the =mailarchiver= user.

#+begin_src bash
sudo -u mailarchiver bash -lc \
    'gunzip -c /tmp/mailarchiver.sql.gz | psql -v ON_ERROR_STOP=1 -d mailarchiver'
#+end_src


** Clean Up Temporary File

#+begin_src bash
sudo rm -f /tmp/mailarchiver.sql.gz
#+end_src


* Start MailArchiver

#+begin_src bash
sudo systemctl start mailarchiver.service
#+end_src

Verify web UI:

#+begin_src bash
curl -I http://localhost:8913
#+end_src


* Cleanup Staging Dataset

Once verified:

#+begin_src bash
sudo zfs destroy -r dpool/tank/restore-staging
#+end_src


* Remove Pre-Restore Snapshots

#+begin_src bash
sudo zfs destroy -r fpool/fast/services/mailarchiver@pre-restore
#+end_src

Verify:

#+begin_src bash
zfs list -t snapshot | grep pre-restore || echo "Snapshots removed"
#+end_src


* Critical Notes

** MailArchiver DataProtection keys are REQUIRED

If lost:

- existing encrypted emails become unreadable
- OAuth sessions become invalid

Dataset:

=/var/lib/mailarchiver=

This is the most critical dataset.


** PostgreSQL contains archive metadata

Includes:

- indexed emails
- metadata
- user associations

Both DB and DataProtection keys must match.


* Best Practices

Always backup together:

- =mailarchiver dataset=
- =postgres database=

Always restore together.
